=define_helper_functions

- parameters = @experiment.get_parameter_ids
-# parameters = %w(a b)
- parameters_labels = parameters


- #experiment_id = params[:id].to_s
- #experiment = Scalarm::Database::Model::Experiment.find_by_id(experiment_id)
- filter = {is_done: true, is_error: {'$exists'=> false}}
- fields = {fields: {result: 1}}
- result = @experiment.simulation_runs.where(filter, fields).first
- outputs=[]
- if result.blank?
  - outputs = ["No results found in completed simulation runs"]
- else
  - outputs = result.result.keys


%section#lindev_charts_form.panel.radius.analysis-chart
  %a.close-reveal-modal &#215
  %h3.subheader="Line charts with standard deviation"
  %h3 #{}
  .row
    .small-5.columns
      %label.inline="Select parameter on X"
    .small-7.columns
      %select(id="firstParam" class ="moes_params_list")
        %optgroup{:label => "Parameters"}
          -parameters.each do |parameter|
            %option{value:parameter} #{parameter}


        %optgroup{:label => "MoEs"}
          -outputs.each do |output|
            %option{value:output} #{output}

  .row
    .small-5.columns
      %label.inline="Select parameter on Y"
    .small-7.columns
      %select(id="secondParam" class ="moes_params_list")
        %optgroup{:label => "Parameters"}
          -parameters.each do |parameter|
            %option{value:parameter} #{parameter}


        %optgroup{:label => "MoEs"}
          -outputs.each do |output|
            %option{value:output} #{output}


  .row
    %ul.inline-list
      %li
        %button.refresh Refresh parameters
      %li
        %button.radius Load chart
      %li
        %a
          %img(src="#{image_url("loading.gif")}" id='busy_lindev' class='loading_chart_gif' size='16x16' style='display: none' )

.charts
  .scripts

:javascript


  $(function(){

    var chart_counter = 0;

    var load_chart = function() {

      var chart_div = $("<div id=\"chart_"+chart_counter+"\">")[0];
      $("#lindevModal .charts").prepend(chart_div);
      var x_axis = $("#lindevModal select#firstParam option:selected").val();
      var y_axis = $("#lindevModal select#secondParam option:selected").val();
      var query_params = "experiment_id=#{@experiment.id}";

      query_params += "&param_x="+x_axis;
      query_params += "&param_y="+y_axis;
      query_params += "&chart_id="+chart_counter;

      var url = "#{@prefix}/chart_instances/lindev?"+query_params;

      var handler = function(data) {
        $("#busy_lindev").hide();
        var targetOffset = $(chart_div).offset().top;
        $('html,body').animate({ scrollTop: targetOffset }, 1000);
        $(chart_div).html(data);
      };
      getWithSession(url, {}, handler, onErrorHandler);
      chart_counter++;

    };
    $("#lindevModal").find("button.refresh").bind("click", function() {
      $("#busy_lindev").show();
      var new_select ="<optgroup label='Parameters'>";
      for (var iter in moes_info_json){
        var param = moes_info_json[iter];
        if (param.type =="")
            new_select = new_select +"</optgroup> <optgroup label='Moes'>"
          else
            new_select = new_select + "<option value='"+param.id+"'>"+param.label+"</option> ";
      }
      new_select = new_select +"</optgroup>"
      update_params_names(new_select);
      $('#busy_lindev').hide();
      toastr.success("Moes refreshed");
     });

    var update_params_names = function(data){
      $(".moes_params_list").each(function(){
        selected_option = $(this).find(":selected").val();
        $(this).html(data);
        $(this).find("option").filter(function(){
          return $(this).val() == selected_option
        }).attr('selected', true)
      });
    };

    $("#lindevModal").find("button.radius").bind("click", function() {
      $("#busy_lindev").show();
      load_chart();
    });
  });