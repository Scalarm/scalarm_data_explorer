- parameters = @experiment.get_parameter_ids

- parameters_labels = parameters
- filter = {is_done: true, is_error: {'$exists'=> false}}
- fields = {fields: {result: 1}}
- result = @experiment.simulation_runs.where(filter, fields).first
- outputs=[]
- if result.blank?
  - outputs = ["No results found in completed simulation runs"]
- else
  - outputs = result.result.keys

%section#threeD_charts_form.panel.radius.analysis-chart
  %a.close-reveal-modal &#215
  %h3.subheader="3d scatter plot charts"
  %h3 #{}
  .row
    .small-5.columns
      %label.inline="Select first parameter"
    .small-7.columns
      %select.firstParam
        %optgroup{:label => "Parameters"}
          -parameters_labels.each do |parameter|
            %option{value:parameter} #{parameter}

        %optgroup{:label => "MoEs"}
          -outputs.each do |output|
            %option{value:output} #{output}

  .row
    .small-5.columns
      %label.inline="Select second parameter"
    .small-7.columns
      %select.secondParam
        %optgroup{:label => "Parameters"}
          -parameters_labels.each do |parameter|
            %option{value:parameter} #{parameter}

        %optgroup{:label => "MoEs"}
          -outputs.each do |output|
            %option{value:output} #{output}

  .row
    .small-5.columns
      %label.inline="Select third parameter"
    .small-7.columns
      %select.thirdParam
        %optgroup{:label => "Parameters"}
          -parameters_labels.each do |parameter|
            %option{value:parameter} #{parameter}


        %optgroup{:label => "MoEs"}
          -outputs.each do |output|
            %option{value:output} #{output}

  .row
    %ul.inline-list
      %li
        %button.radius Load chart
      %li
        %img(src="#{image_url("loading.gif")}" id='busy_3d' class='loading_chart_gif' size='16x16' style='display: none' )




.charts
  .scripts

:javascript

  $(function(){


    var three_d_chart_counter = 0;
    var load_chart = function() {

      var three_d_chart_div = $("<div id=\"three_d_chart_"+three_d_chart_counter+"\">")[0];
      $("#three_dModal .charts").prepend(three_d_chart_div);
      //TODO - if there's nothing to select -> do nothing
      var x_axis = $("#three_dModal .firstParam option:selected").val();
      var y_axis = $("#three_dModal .secondParam option:selected").val();
      var z_axis = $("#three_dModal .thirdParam option:selected").val();
      var query_params = "experiment_id=#{@experiment.id}";
      query_params += "&param_x="+x_axis;
      query_params += "&param_y="+y_axis;
      query_params += "&param_z="+z_axis;
      query_params += "&chart_id="+three_d_chart_counter;

      var url = "#{@prefix}/chart_instances/three_d?"+query_params;

      var handler = function(data) {
        $("#busy_3d").hide();
        var targetOffset = $(three_d_chart_div).offset().top;
        $('html,body').animate({ scrollTop: targetOffset }, 1000);
        $(three_d_chart_div).html(data);
      };
      getWithSession(url, {}, handler, onErrorHandler);
      three_d_chart_counter++;

    };

    $("#three_dModal").find("button").bind("click", function() {
      $("#busy_3d").show();
      load_chart();
    });
  });
